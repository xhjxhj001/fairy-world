# 安全性改进文档

## 修复的安全问题

### 1. ✅ 移除客户端数据存储
**问题**：游戏状态和账号密码存储在浏览器localStorage中，可被轻易访问和篡改

**解决方案**：
- 完全移除localStorage中的游戏状态存储
- 游戏数据仅保存在服务器端
- localStorage仅保留当前用户的基本信息（不含密码和游戏数据）

### 2. ✅ 服务器端账号管理系统
**问题**：所有认证逻辑在客户端，无服务器端验证，易被绕过

**解决方案**：
- 实现完整的服务器端用户注册和登录系统
- 账号数据存储在服务器端的 `user_data/accounts.json`
- 使用bcrypt算法加密密码（自动加盐，防止彩虹表攻击）
- 实现会话管理系统（sessionId），支持24小时会话有效期

### 3. ✅ 并发安全保护
**问题**：多个请求同时读写文件可能导致数据竞争和损坏

**解决方案**：
- 使用 `proper-lockfile` 实现文件锁机制
- 所有文件读写操作都使用锁保护
- 支持自动重试（最多5次）和死锁检测（10秒超时）

### 4. ✅ 输入验证和清理
**问题**：服务器端无输入验证，可能导致注入攻击

**解决方案**：
- 实现完整的输入验证系统：
  - 用户名：4-20个字符，只允许字母、数字、下划线
  - 昵称：2-10个字符
  - 密码：至少6个字符
- 游戏状态数据清理函数，过滤非法字段
- 所有用户输入都经过严格验证

### 5. ✅ 身份认证机制
**问题**：WebSocket连接无真正的身份验证

**解决方案**：
- 实现基于sessionId的认证系统
- 用户登录后获得sessionId（24小时有效）
- 每次WebSocket连接都需要验证sessionId
- 未认证的连接无法执行敏感操作
- 定期清理过期会话

### 6. ✅ 安全的访客模式
**问题**：访客ID在客户端生成，可能冲突

**解决方案**：
- 服务器端生成唯一访客ID
- 访客数据不持久化（仅内存）
- 访客无法执行需要持久化的操作

## 安全架构

### 数据存储
```
user_data/
├── accounts.json          # 用户账号信息（bcrypt加密密码）
├── username1.json         # 用户1的游戏数据
├── username2.json         # 用户2的游戏数据
└── ...
```

### 认证流程
1. **注册**：客户端 → 服务器验证 → bcrypt加密 → 保存账号
2. **登录**：客户端 → 服务器验证密码 → 生成sessionId → 返回sessionId
3. **游戏连接**：客户端发送sessionId → 服务器验证 → 加载游戏数据

### 数据保护
- 所有密码使用bcrypt加密（cost factor = 10）
- 文件操作使用锁保护，防止并发冲突
- 会话自动过期，防止会话劫持
- 输入验证防止注入攻击

## 依赖更新

新增安全相关依赖：
- `bcrypt`: ^5.1.1 - 密码加密
- `proper-lockfile`: ^4.1.2 - 文件锁
- `ws`: ^8.14.2 - WebSocket服务器

## 安装依赖

```bash
cd /Users/xuhuanju/personal/Agent/fine-apps/idle-game-1
npm install
```

## API安全

### 认证端点
- `register`: 注册新用户
- `login`: 用户登录
- `guest_login`: 访客登录
- `session_auth`: 会话认证

### 保护的操作（需要认证）
- `save_game`: 保存游戏数据
- `share_location`: 分享地点
- `friend_request`: 好友申请
- `send_gift`: 赠送礼物

### 错误处理
- 认证失败自动跳转到登录页
- 会话过期提示用户重新登录
- WebSocket错误不暴露敏感信息

## 注意事项

1. **生产环境建议**：
   - 使用HTTPS和WSS协议
   - 使用专业数据库替代JSON文件存储
   - 实现更完善的日志系统
   - 添加速率限制防止暴力破解
   - 实现CSRF保护

2. **密码策略**：
   - 当前最低6个字符
   - 建议生产环境增加复杂度要求

3. **会话管理**：
   - 当前会话有效期24小时
   - 可根据需求调整
   - 建议实现"记住我"功能

## 测试建议

1. 测试注册和登录流程
2. 测试并发保存（多个标签页同时保存）
3. 测试会话过期处理
4. 测试访客模式
5. 测试离线收益计算

