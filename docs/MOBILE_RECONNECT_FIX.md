# 手机锁屏自动重连功能 - 快速说明

## ✅ 解决的问题

**问题：**
- 📱 手机锁屏后 WebSocket 断开
- 🔓 解锁后不会自动重连
- 💔 操作数据未保存到服务器

**解决：**
- ✅ 锁屏后自动保存数据
- ✅ 解锁时自动检测并重连
- ✅ 网络恢复自动重连
- ✅ 可视化连接状态指示器

## 🎨 连接状态指示器

位置：顶部状态栏，用户昵称旁边

### 状态说明

| 显示 | 颜色 | 含义 | 操作 |
|------|------|------|------|
| ● | 🟢 绿色 | 已连接 | 正常使用 |
| ● | 🟠 橙色（闪烁） | 连接中/重连中 | 等待连接 |
| ● | 🔴 红色 | 已断开/错误 | 点击手动重连 |
| ● | ⚫ 灰色 | 连接失败 | 点击重试 |

### 查看详情
- 鼠标悬停在圆点上
- 查看详细状态信息
- 如：<br>"重连中 (3/10)..."

## 🔄 自动重连机制

### 触发条件
1. **锁屏解锁** - 自动检测并重连
2. **网络恢复** - WiFi/4G 恢复后自动重连
3. **标签切换** - 切回标签页自动检查连接
4. **连接断开** - 自动尝试重连（最多10次）

### 重连策略
- 第1次：2秒后
- 第2次：4秒后
- 第3次：8秒后
- ...
- 最多：30秒间隔

## 📱 使用场景

### 场景1：接电话
```
1. 正在玩游戏
2. 接听电话（屏幕锁定）
3. 🟢 → ⚫ (连接断开)
4. 保存数据到本地
5. 通话结束，解锁手机
6. ⚫ → 🟠 (开始重连)
7. 🟠 → 🟢 (重连成功)
✅ 数据正常同步
```

### 场景2：网络波动
```
1. WiFi 信号不稳定
2. 🟢 → 🔴 (断开)
3. 自动尝试重连
4. 网络恢复
5. 🔴 → 🟠 → 🟢
✅ 无需手动操作
```

### 场景3：切换标签
```
1. 切换到其他标签页
2. 数据自动保存
3. 切换回游戏标签
4. 自动检测连接状态
5. 必要时自动重连
✅ 连接保持活跃
```

## 💡 使用技巧

### 手动重连
如果看到红色或灰色圆点：
1. 点击圆点
2. 触发立即重连
3. 观察状态变化

### 查看日志
打开浏览器开发者工具（F12）：
- Console 选项卡
- 查看详细连接日志
- 包括重连尝试、成功/失败信息

## ⚠️ 注意事项

### 数据安全
- **页面后台时**：自动保存数据
- **重连成功后**：数据自动同步
- **重连失败后**：数据暂存本地

### 最佳实践
1. 看到绿色圆点 = 放心操作
2. 看到橙色圆点 = 稍等片刻
3. 看到红色圆点 = 点击重连
4. 重要操作前确认连接状态

## 🧪 快速测试

### 测试步骤
1. 手机打开游戏
2. 查看顶部状态栏（应该是绿色●）
3. 锁定屏幕10秒
4. 解锁屏幕
5. 观察圆点变化：
   - ⚫/🔴 → 🟠（闪烁）→ 🟢
6. ✅ 自动重连成功

### 验证方法
```
# 在浏览器控制台观察日志：
📱 页面进入后台
🔌 与服务器断开连接
📱 页面重新可见，检查连接状态...
🔄 检测到断开，尝试重连...
🔗 正在连接到游戏服务器...
✅ 已连接到游戏服务器
```

## 🎯 技术特点

### 智能检测
- ✅ 页面可见性检测（visibilitychange）
- ✅ 网络状态检测（online/offline）
- ✅ WebSocket 状态检测
- ✅ 心跳包检测（ping/pong）

### 用户友好
- ✅ 可视化状态指示
- ✅ 平滑动画过渡
- ✅ 手动重连选项
- ✅ 详细状态提示

### 性能优化
- ✅ 指数退避策略
- ✅ 最大重试次数限制
- ✅ 页面不可见时不重连
- ✅ 避免频繁请求

## 📖 详细文档

更多技术细节请查看：
- `WEBSOCKET_RECONNECT.md` - 完整技术文档

## 🆘 常见问题

### Q: 圆点一直是红色怎么办？
A: 
1. 检查网络连接
2. 确认服务器运行
3. 点击圆点手动重连
4. 查看控制台错误信息

### Q: 重连后数据丢失？
A: 
- 访客模式：数据保存在 localStorage
- 注册用户：数据保存在服务器
- 断线期间的操作会在重连后同步

### Q: 能否关闭自动重连？
A: 
- 自动重连是必要功能
- 最多尝试10次后自动停止
- 可手动点击重连

---

修复日期：2025-12-07

