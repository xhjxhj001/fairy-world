# 离线收益系统说明

## 功能概述

游戏现在支持离线收益！即使你关闭了游戏，小狐狸也会继续自动收集资源。当你再次登录时，会看到一个精美的弹窗展示你的离线收益。

## 功能特性

### 1. 自动数据保存

- **本地保存**: 游戏数据会保存到浏览器的 localStorage
- **服务器保存**: 游戏数据会自动保存到服务器的本地文件中（`user_data/` 目录）
- **自动保存频率**: 每30秒自动保存一次
- **关键操作保存**: 在旅行、收集资源、好友互动等操作后立即保存

### 2. 离线收益计算

当你离线时，游戏会自动计算你的收益：

- **阳光露珠**: 每小时自动生成 20 个
- **星光**: 每小时自动生成 20 个
- **最大时长**: 最多计算 24 小时的离线收益

**示例**：
- 离线 1 小时：获得 20 阳光 + 20 星光
- 离线 12 小时：获得 240 阳光 + 240 星光
- 离线 48 小时：获得 480 阳光 + 480 星光（上限24小时）

### 3. 离线收益展示

登录时如果有离线收益，会自动弹出一个精美的弹窗，显示：
- 离线时长
- 获得的阳光露珠数量
- 获得的星光数量
- 温馨提示

点击"领取奖励"按钮即可关闭弹窗并领取奖励。

### 4. 数据存储位置

- **用户账号数据**: 存储在 `localStorage` 中的 `gameUsers` 键
- **当前用户**: 存储在 `localStorage` 中的 `currentUser` 键
- **游戏状态**: 存储在 `localStorage` 和服务器 `user_data/用户名.json` 文件中

## 用户数据文件格式

每个用户在服务器上都有一个独立的 JSON 文件：

```json
{
  "username": "user123",
  "gameState": {
    "sunlight": 100,
    "starlight": 50,
    "photos": [...],
    "friends": [...],
    ...其他游戏数据
  },
  "lastLogout": 1701687654321
}
```

## 使用说明

### 正常流程

1. **首次登录**: 注册账号或使用访客模式
2. **游戏过程**: 游戏会每30秒自动保存
3. **退出游戏**: 关闭浏览器标签页（会自动保存最后状态）
4. **再次登录**: 输入账号密码，系统会自动：
   - 加载你的游戏数据
   - 计算离线收益
   - 显示离线收益弹窗
   - 自动将离线收益添加到你的资源中

### 多设备同步

- 如果在不同设备上登录同一账号，会加载服务器上最新的游戏数据
- 建议在切换设备前，等待30秒让当前设备完成自动保存

### 访客模式

- 访客账号也支持离线收益
- 但访客数据可能在清除浏览器缓存后丢失
- 建议注册正式账号以获得更好的体验

## 注意事项

1. **服务器必须运行**: 离线收益功能需要 WebSocket 服务器运行
   ```bash
   node server.js
   ```

2. **数据安全**: 用户数据文件存储在服务器本地，请妥善备份 `user_data/` 目录

3. **离线上限**: 为了游戏平衡，离线收益最多计算24小时

4. **网络断线**: 如果无法连接服务器，游戏仍可正常运行，但数据只会保存在本地

5. **密码加密**: 密码使用 SHA256 加密存储，但仍建议使用强密码

## 故障排查

### 问题1: 没有显示离线收益

**可能原因**:
- 离线时间少于1分钟
- 服务器未运行
- 首次登录（没有历史数据）

**解决方案**:
- 确保服务器运行：`node server.js`
- 检查浏览器控制台是否有错误信息

### 问题2: 数据未保存

**可能原因**:
- 服务器连接失败
- 文件写入权限问题

**解决方案**:
- 检查 `user_data/` 目录是否存在且有写入权限
- 查看服务器终端输出的错误信息

### 问题3: 离线收益数值异常

**可能原因**:
- 系统时间被修改
- 数据文件损坏

**解决方案**:
- 确保系统时间正确
- 备份并删除损坏的用户数据文件，重新登录

## 技术实现

- **前端**: 使用 WebSocket 与服务器通信
- **后端**: Node.js + ws 库
- **存储**: JSON 文件 + localStorage
- **加密**: CryptoJS SHA256

## 未来计划

- [ ] 增加云存储备份
- [ ] 支持数据导出/导入
- [ ] 增加离线事件系统（离线期间也可能发生随机事件）
- [ ] 离线收益加成道具

